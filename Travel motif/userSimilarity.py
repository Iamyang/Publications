#-------------------------------------------------------------------------------
# Name:        婵犵數濮烽弫鍛婃叏閻戣棄鏋侀柛娑橈攻閸欏繘鏌ｉ幋锝嗩棄闁哄绶氶弻娑樷槈濮楀牊鏁鹃梺鍛婄懃缁绘﹢寮婚敐澶婄闁挎繂妫Λ鍕⒑閸濆嫷鍎庣紒鑸靛哺瀵鈽夊Ο閿嬵潔濠殿喗顨呴悧濠囧极妤ｅ啯鈷戦柛娑橈功閹冲啰绱掔紒姗堣€跨€殿喖顭烽弫鎰緞婵犲嫷鍚呴梻浣瑰缁诲倸螞椤撶倣娑㈠礋椤栨稈鎷洪梺鍛婄箓鐎氱兘宕曟惔锝囩＜闁兼悂娼ч崫铏光偓娈垮枦椤曆囧煡婢跺á鐔兼煥鐎ｅ灚缍屽┑鐘愁問閸犳銆冮崨瀛樺亱濠电姴娲ら弸浣肝旈敐鍛殲闁抽攱鍨块弻娑樷槈濮楀牆濮涢梺鐟板暱閸熸壆妲愰幒鏃傜＜婵鐗愰埀顒冩硶閳ь剚顔栭崰鏍€﹂悜钘夋瀬闁归偊鍘肩欢鐐测攽閻樻彃顏撮柛姘噺缁绘繈鎮介棃娴躲垽鏌ｈ箛鏂垮摵鐎规洘绻堝浠嬵敃閵堝浂妲告繝寰锋澘鈧洟骞婅箛娑樼厱闁硅揪闄勯埛鎴炪亜閹扳晛鈧洘绂掑鍫熺厾婵炶尪顕ч悘锟犳煛閸涱厾鍩ｆい銏″哺閸┾偓妞ゆ帒瀚拑鐔哥箾閹寸偟鎳呯紒鈾€鍋撻梻浣侯焾閺堫剛绮欓幋鐐殿浄闁哄鍤﹂弮鍫熷亹闂傚牊绋愬▽顏堟⒑閸涘﹥鈷愰柣妤佺矒楠炴垿濮€閻橆偅鏂€闁诲函缍嗘禍鐐核囬妸銉富闁靛牆鎳愮粻鐗堜繆椤愶綆娈曟い銊ｅ劦瀹曠喖顢涘☉鎺撳濠电偠鎻徊鍧椻€﹂崼銉ユ辈闂侇剙绉甸悡娆戠棯閺夊灝鑸瑰ù婊呭閵囧嫰濮€閿涘嫬鈷岄悗瑙勬礀閻栧ジ宕洪敓鐘茬妞ゅ繐妫楃敮顒€鈹戦敍鍕杭闁稿﹥鐗曡灋闁告劦鍠栭弸浣广亜閺囨浜鹃悗瑙勬礃閸ㄥ潡鐛鈧幊婊堟濞戞瑧鈧參姊绘担鍛婂暈婵炶绠撳畷婊冣槈閵忊剝娅栧┑顔姐仜閸嬫挻鎱ㄦ繝鍐┿仢鐎规洏鍔嶇换婵嬪礃閿濆棗顏搁梻鍌欑劍閹爼宕濇惔銊ユ瀬濠电姵鍝庨埀顑跨椤繈鎳滈崹顐ｇ彸濠电姰鍨煎▔娑㈡晝椤忓牆鑸归柛顐ｆ礃閳锋垿鏌涘┑鍡楊仾鐎瑰憡绻堥弻娑氣偓锝庡墮閺嬫稒銇勯姀鈽呰€跨€规洦鍋婂畷鐔煎Ω閿旇姤婢戦梻鍌欒兌缁垶鈥﹂崶鈺佸灊妞ゆ牗鍩冨Σ鍫㈡喐閺冨牆钃熼柨婵嗘啒閺冨牆鐒垫い鎺戝閻ゎ噣鏌℃径瀣仼闁哄棴绠撻弻鐔告綇閸撗呮殸缂備胶濮风划顖滄崲濞戙垺鍤戞い鎺戝€哥粭锟犳⒑閸濆嫭瀚呯紓宥勭椤繘鎼归崷顓狅紲濠碘槅鍨靛▍锝嗙閺夋垟鏀介柍钘夋娴滄繈鏌ｉ悢婵嗘搐閻掑灚銇勯幒鎴濐仾婵炴嚪鍥ㄧ厽妞ゆ挾鍋涢埀顒佹倐閿濈偠绠涢幘浣规そ椤㈡棃宕担璇℃濠电姷鏁搁崑鐐哄垂閸洘鍤屽Δ锝呭暔閳ь剙鍊哥叅妞ゅ繐鎳夐幏铏圭磼缂併垹骞栭柟鍐茬箻閹敻顢旈崼鐔哄幈闂佸搫鍟犻崑鎾淬亜閵娿儳澧︾€规洘宀搁獮鎺楀籍閸屾粣绱叉繝纰樻閸垳鎷冮敃鍌氬惞闁靛牆顦伴悡鐔煎箹濞ｎ剙鐏柍顖涙礃閵囧嫰顢橀悙鏉戞灎閻庤娲忛崹浠嬪箰婵犲啫绶為柛鈩兩戦弶鎼佹⒑閸︻厼鍔嬪┑鐐诧工閻ｇ兘骞囬弶璺ㄧ杸闂佸搫顦冲▔鏇㈡晬濞戙垺鈷戦柣鐔告緲閳锋梻绱掔紒妯肩畼闁瑰箍鍨藉畷鍗炍熼梹鎰泿闂備浇顫夊妯绘櫠鎼淬劌绠栭柤娴嬫櫇绾惧ジ鏌ｅ鈧褎绂掗敂濮愪簻闁靛绲介崝锕傛煙椤旂晫鎳囨鐐存崌楠炴帡骞橀幖顓炴櫔闂傚倸鍊峰ù鍥敋閺嶎厼绐楁俊銈呮噺閸嬶繝鏌嶆潪鎷屽厡闁哄棴闄勯妵鍕箛閸撲胶鏆犵紓浣插亾閻庯綆鍋佹禍婊堟煙閹佃櫕娅呴柍褜鍓氶崝娆忕暦閹达箑绠绘繛鑼帛閺咃綁姊虹紒妯虹仴婵☆偅鐟ч埀顒勬涧閻倸顫忓ú顏咁棃婵炴垶鑹鹃。鍝勨攽閳藉棗浜濇い銊ユ楠炲牓濡搁敃鈧欢鐐测攽閻愰潧浜鹃柡鍌楀亾濠碉紕鍋戦崐鏍涙笟鈧畷鎴﹀箛閻楀牊娅栭悗骞垮劚椤︿即鎮￠悩鍙傛棃鏁冮埀顒€顭囬敓鐘蹭紶闁惧繐婀辩壕鑲╃磽娴ｈ鐒界紒鐘虫尰閵囧嫰顢曢敐鍥╃杽濡炪們鍨洪敋闁宠棄顦埢搴ょ疀閿濆嫮妞介梻鍌氬€搁崐鎼佸磹妞嬪孩顐芥慨姗嗗墻閻掍粙鏌ゆ慨鎰偓鎰板磻閹剧粯顥堟繛鎴炴皑閸旑垶鎮楃憴鍕８闁搞劏娅ｇ紓鎾绘偩瀹€鈧惌娆撴偣娓氼垳鍘涙俊鑼厴濮婅櫣鎷犻幓鎺戞瘣缂傚倸绉村Λ婵嗙暦閺夎鏃堝川椤旈棿绨甸梻浣告惈濞层垽宕瑰ú顏呭亗闊洦鎸撮弨浠嬫煟閹邦厼鐏ラ柛鐕佸亰椤㈡棃顢旈崨顔煎伎闂佹寧绻傞幊鎰櫠閿曞倹鐓欐い鏃傜摂濞堟棃鏌嶇紒妯诲磳鐎规洖缍婇、娆撴偩鐏炲吋鍠氬┑鐘垫暩婵兘寮幖浣哥；婵炴垯鍨洪弲婵囥亜韫囨挾澧㈢€规挷绶氶弻娑㈠箛閳轰礁唯闂佸搫顑呴柊锝夊蓟閻斿吋鍊锋い鎺嶈兌缁嬪洭姊洪柅鐐茶嫰婢ф壆绱掗鍛仭缂佸矁椴哥换婵嬪炊閼稿灚娅栨繝鐢靛Т閿曘倝宕锝囶浄婵☆垯缍嶉弮鍫熷亹闂傚牊绋愬▽顏勵渻閵堝啫濡兼俊顐ｇ洴楠炴垿濮€閻橆偅鏂€闁诲函缍嗛崑鍕濞差亝鈷掗柛灞炬皑婢ф盯鏌涢幒鍡椾壕闂備線娼х换鍫ュ磹閺嶎厽鍋傞柣鏃囧亹閸欐捇鏌涢妷锝呭闁绘挶鍎甸弻娑樷攽婵犲喚浠╅梺閫炲苯澧叉い顐㈩槸鐓ゆ俊顖氬悑瀹曟煡鏌涢鐘插姢鐎规挷绶氶弻鐔兼倻濡儤顔曢梺鍝勫暊閸嬫捇鏌熷畡鐗堝殗鐎规洦鍋婂畷鐔碱敃瀹ュ啫濡奸柍瑙勫灴閺佸秹宕熼鈩冩線闂備胶顭堥敃銉╂偋閻樿绠栫憸宥夆€﹂妸鈺侀唶婵犻潧鐗炵槐閬嶆⒒娴ｈ櫣甯涢柛鏃€顨婂畷鏇㈠Χ婢跺﹦锛?
# Purpose:
#
# Author:      lenovo
#
# Created:     08/04/2017
# Copyright:   (c) lenovo 2017
# Licence:     <your licence>
#-------------------------------------------------------------------------------
import numpy as np
import os
import functions
import math
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import axes3d
import matplotlib as mpl
from scipy.cluster.hierarchy import dendrogram
def topoVec12(motifID):
    tpvec=np.array([0]*12)
    if motifID==1:
        return tpvec
    tpvec[motifID-2]=1
    return tpvec
def topoVec4(motifID):
    tpvec=np.array([0]*4)
    type1=[2,4,8,9,10]
    type2=[3,5]
    type3=[3,6]
    type4=[3,7]
    if motifID in type1:
        tpvec[0]=1
    elif motifID in type2:
        tpvec[1]=1
    elif motifID in type3:
        tpvec[2]=1
    elif motifID in type4:
        tpvec[3]=1
    else:
        print('error')
        return 'error'
    return tpvec
def temVec4(tempMotifID):
    tevec=np.array([0]*4)
    tevec[tempMotifID-1]=1
    return tevec
def timeRepre(timeseq):
    tRepre=np.array([0]*3)
    ltime=len(timeseq)
    tRepre[0]=timeseq[0]
    tRepre[1]=timeseq[1]
    if ltime==2:
        tRepre[2]=-100
    elif ltime==3:
        tRepre[2]=timeseq[2]
    elif ltime>3:
        tRepre[2]=sum(timeseq[2:])/(ltime-2)
    else:
        print('Error')
        return 'Error'
    return tRepre
def temVec13(timeseq):
    tvec=np.array([0]*13)
    trepre=timeRepre(timeseq)
    teid=judgeTempMo_13types(trepre[0],trepre[1],trepre[2])
    tvec[teid-1]=1
    return tvec
def judgeTempMo_4types(t1,t2,t3):
    fixed=1/6
    if t1-t2>fixed and t2-t3>fixed:
        return 1
    elif t1-t3>fixed and t3-t2>fixed:
        return 1
    elif t1-t3>fixed and t1-t2>fixed and abs(t3-t2)<=fixed:
        return 1
    elif t2-t1>fixed and t1-t3>fixed:
        return 2
    elif t2-t3>fixed and t3-t1>fixed:
        return 2
    elif t2-t3>fixed and t2-t1>fixed and abs(t3-t1)<=fixed:
        return 2
    elif t3-t1>fixed and t1-t2>fixed:
        return 3
    elif t3-t2>fixed and t2-t1>fixed:
        return 3
    elif t3-t2>fixed and t3-t1>fixed and abs(t2-t1)<=fixed:
        return 3
    elif t3-t2<fixed and t3-t1<fixed and abs(t2-t1)<=fixed:
        return 4
    elif t2-t3<fixed and t2-t1<fixed and abs(t3-t1)<=fixed:
        return 4
    elif t1-t3<fixed and t1-t2<fixed and abs(t3-t2)<=fixed:
        return 4
    elif abs(t2-t1)<=fixed and abs(t3-t2)<=fixed and abs(t3-t1)<=fixed:
        return 4
    else:
        print('error')
        return 14
def judgeTempMo_13types(t1,t2,t3):
    fixed=1/6
    if t1-t2>fixed and t2-t3>fixed:
        return 1
    elif t1-t3>fixed and t3-t2>fixed:
        return 2
    elif t1-t3>fixed and t1-t2>fixed and abs(t3-t2)<=fixed:
        return 3
    elif t2-t1>fixed and t1-t3>fixed:
        return 4
    elif t2-t3>fixed and t3-t1>fixed:
        return 5
    elif t2-t3>fixed and t2-t1>fixed and abs(t3-t1)<=fixed:
        return 6
    elif t3-t1>fixed and t1-t2>fixed:
        return 7
    elif t3-t2>fixed and t2-t1>fixed:
        return 8
    elif t3-t2>fixed and t3-t1>fixed and abs(t2-t1)<=fixed:
        return 9
    elif t3-t2<fixed and t3-t1<fixed and abs(t2-t1)<=fixed:
        return 10
    elif t2-t3<fixed and t2-t1<fixed and abs(t3-t1)<=fixed:
        return 11
    elif t1-t3<fixed and t1-t2<fixed and abs(t3-t2)<=fixed:
        return 12
    elif abs(t2-t1)<=fixed and abs(t3-t2)<=fixed and abs(t3-t1)<=fixed:
        return 13
    else:
        print('error')
        return 14
def judgeSemMo_13types(t1,t2,t3):
    fixed=0
    if t1-t2<fixed and t2-t3<fixed:
        return 1
    elif t1-t3<fixed and t3-t2<fixed:
        return 2
    elif t1-t3<fixed and t1-t2<fixed and abs(t3-t2)<=fixed:
        return 3
    elif t2-t1<fixed and t1-t3<fixed:
        return 4
    elif t2-t3<fixed and t3-t1<fixed:
        return 5
    elif t2-t3<fixed and t2-t1<fixed and abs(t3-t1)<=fixed:
        return 6
    elif t3-t1<fixed and t1-t2<fixed:
        return 7
    elif t3-t2<fixed and t2-t1<fixed:
        return 8
    elif t3-t2<fixed and t3-t1<fixed and abs(t2-t1)<=fixed:
        return 9
    elif t3-t2>fixed and t3-t1>fixed and abs(t2-t1)<=fixed:
        return 10
    elif t2-t3>fixed and t2-t1>fixed and abs(t3-t1)<=fixed:
        return 11
    elif t1-t3>fixed and t1-t2>fixed and abs(t3-t2)<=fixed:
        return 12
    elif abs(t2-t1)<=fixed and abs(t3-t2)<=fixed and abs(t3-t1)<=fixed:
        return 13
    else:
        print('error')
        return 14
def orderSum(semseq):
    lsem=len(semseq)
    count={}
    c2={}
    for i in range(1,4):
        count[i]=0
        c2[i]=0
    for i in range(lsem):
        count[semseq[i]]+=i+1
        c2[semseq[i]]+=1
    for i in range(1,4):
        if c2[i]==0:
            count[i]=100
        else:
            count[i]=count[i]/c2[i]
    return count
def semaSeqVec13(semseq):
    vec=np.array([0]*13)
    osum=orderSum(semseq)
    sid=judgeSemMo_13types(osum[1],osum[2],osum[3])
    vec[sid-1]=1
    return vec
def semaPortionVec3(semseq):
    lsem=len(semseq)
    count={}
    for i in range(1,4):
        count[i]=0
    for i in range(lsem):
        count[semseq[i]]+=1
    vec=np.array([count[1]/lsem,count[2]/lsem,count[3]/lsem])
    return vec
def userMatrixNew():
    fdir="E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName"
    os.chdir(fdir)
    cateNumber=3
    username=functions.readPickle("lmtimeCategory"+str(cateNumber))
    lenu=len(username)
    matrix=[]
    names={}
    for i in range(lenu):
        moid=username[i][2]
        hlocations=username[i][3]
        name=username[i][0][:-3]
        if moid==1:
            continue
        else:
            time=username[i][4]
            lmtime=username[i][5]
            seq=[]
            seqtime=[]
            llmtime=len(lmtime)
            for j in range(llmtime):
                seq.append(lmtime[j][0])
                seqtime.append(time[hlocations[j]])
            vectp=topoVec4(moid)
            vectem=temVec13(seqtime)
            vecseseq=semaSeqVec13(seq)
            #vecsepor=semaPortionVec3(seq)
            #vector=np.hstack((vectp,vectem,vecseseq,vecsepor))
            vector=np.hstack((vectp,vectem,vecseseq))
            if name in names:
                names[name]+=vector
            else:
                names[name]=vector
    namelist=[]
    for name, vector in names.items():
        matrix.append(vector)
        namelist.append(name)
    matarray=np.array(matrix)
    nameArray=np.array(namelist)
    return matarray,nameArray
def denMatrix(matrix):
    simi=functions.vectorSimi(matrix)
    nsimi,ind,linkage=functions.linkage(simi)
    return nsimi,ind,linkage

def userIndex():
    userind=np.array([0]*1392)
    userind[:545]=2
    userind[545:611]=3
    userind[611:928]=4
    userind[928:951]=5
    userind[951:983]=6
    userind[983:1006]=7
    userind[1006:1180]=8
    userind[1180:1196]=9
    userind[1196:1291]=10
    userind[1291:1348]=11
    userind[1348:1374]=12
    userind[1374:1392]=13
    return userind
def tMotif4567():
    fdir="E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName"
    os.chdir(fdir)
    cateNumber=3
    username=functions.readPickle("lmtimeCategory"+str(cateNumber))
    lenu=len(username)
    no3=[4,5,6,7]
    matrix=np.zeros((4,13))
    for i in range(lenu):
        moid=username[i][2]
        hlocations=username[i][3]
        if moid not in no3:
            continue
        else:
            time=username[i][4]
            motemtype=judgeTempMo_13types(time[hlocations[0]],time[hlocations[1]],time[hlocations[2]])
            matrix[moid-4,motemtype-1]+=1
    for k in range(4):
        matrix[k,:]=matrix[k,:]/sum(matrix[k,:])
    return matrix

def sMotif4567():
    fdir="E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName"
    os.chdir(fdir)
    cateNumber=3
    username=functions.readPickle("lmtimeCategory"+str(cateNumber))
    lenu=len(username)
    no3=[4,5,6,7]
    matrix=np.zeros((4,13))
    for i in range(lenu):
        moid=username[i][2]
        hlocations=username[i][3]
        if moid not in no3:
            continue
        else:
##            time=username[i][4]
##            motemtype=judgeTempMo_13types(time[hlocations[0]],time[hlocations[1]],time[hlocations[2]])
            lmtime=username[i][5]
            seq=[]
            llmtime=len(lmtime)
            for j in range(llmtime):
                seq.append(lmtime[j][0])
            osum=orderSum(seq)
            sid=judgeSemMo_13types(osum[1],osum[2],osum[3])
            matrix[moid-4,sid-1]+=1

    for k in range(4):
        matrix[k,:]=matrix[k,:]/sum(matrix[k,:])
    return matrix

def userAnalysis(matrix,names,nsimi,sample):
    fdir="E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName"
    os.chdir(fdir)
    cateNumber=3
    username=functions.readPickle("lmtimeCategory"+str(cateNumber))
    lenu=len(username)
    for ind in sample:
        print(ind)
        print(names[ind])
        print(matrix[ind])
        for i in range(lenu):
            moid=username[i][2]
            hlocations=username[i][3]
            name=username[i][0][:-3]
            if name==names[ind]:
                print(username[i])
        print('-'*40)
def eigenSpace(matrix):
    sampleIndex=np.hstack((np.arange(0,50),np.arange(250,300),np.arange(700,750)))
    sam_matrix=matrix[sampleIndex,:]
##    sam=np.zeros((3,50,30))
##    sam[0]=matrix[0:50:1,:]
##    sam[1]=matrix[250:300:1,:]
##    sam[2]=matrix[700:750:1,:]
    eva,eve=functions.pca(sam_matrix)
    indsort=np.argsort(-eva)
    indeve=np.array([0,1,2])
    eveSelect=eve[:,indsort[indeve]]
    nmat=np.dot(sam_matrix,eveSelect)
    #pHist(nmat[50:100:1,2])
    pEigenSpace_3d((nmat[0:50:1,:],nmat[50:100:1,:],nmat[100:150:1,:]),indeve+1)
    pEigenSpace_1((nmat[0:50:1,:],nmat[50:100:1,:],nmat[100:150:1,:]),indeve+1)
def pDendro(linkage_mat,label):
    fig,ax=plt.subplots(figsize=(8,8))
    ax=dendrogram(linkage_mat,orientation="left",leaf_font_size=6)
    plt.tick_params(
        axis= 'x',          # 濠电姷鏁告慨鐑藉极閹间礁纾婚柣妯款嚙缁犲灚銇勮箛鎾搭棤缂佲偓婵犲洦鐓冪憸婊堝礈濮樿鲸宕叉繛鎴炵懃缁剁偤鎮楅敐搴′簽妞わ缚鍗抽幃?x 闂傚倸鍊搁崐鎼佸磹閻戣姤鍤勯柛顐ｆ穿缂嶆牠鎮楅敐搴℃灈缂佲偓鐎ｎ偁浜滈柟鎵虫櫅閻掔儤绻涢崗鍏碱棃婵﹦绮幏鍛存惞閻熸壆顐奸梻浣虹帛椤ㄥ繘宕㈤幆褜鍤楀┑鐘叉搐缁犳氨鎲稿鍫熷€?
        which='both',      # 闂傚倸鍊搁崐鎼佸磹妞嬪海鐭嗗〒姘ｅ亾妤犵偛顦甸弫鎾绘偐閸愬弶鐤勫┑掳鍊х徊浠嬪疮椤愩倐鍋撳顒夋Ч闁靛洤瀚伴獮鎺楀幢濡炴儳顥氬┑锛勫亼閸娿倖绂嶅鍫濈柈闁哄鍨归弳锕傛煙閻戞ê鐏嶆俊鎻掔墛缁绘盯宕卞Δ浣侯洶闂侀€炲苯澧柟鐟版喘瀵鏁愭径瀣汗闂佺绻愰幊鎾诲春閸涘瓨鈷戦柛娑橈攻閻撱儳绱掓径灞惧殌妞ゆ洩绲块埀顒€婀辨慨鐑芥偪閳ь剟姊洪崷顓℃闁搞劑浜堕敐鐐差吋婢跺鎷洪柣鐔哥懃鐎氼剛绮堥崘鈹夸簻闁哄洨鍠撴晶鐢碘偓瑙勬礋濞佳囧煝鎼淬劌绠婚悗鐢殿焾楠炲牓姊绘担鍝ワ紞闁硅櫕鎹囬幃妯衡攽鐎ｎ偄鈧埖銇勮箛鎾跺闁绘挻鐟﹂妵鍕冀閵娧€濮囧銈冨劚閻楁捇寮婚埄鍐╁缂佸绨遍崑鎾诲锤濡も偓缁犳牠鏌涢幘妤€鍊归崟鍐⒑娴兼瑧鍒板┑鍌涙⒒濡叉劕螣閼测晝锛濋梺绋挎湰閼归箖鍩€椤掑倸鍘撮柟顔惧仱閺佸倿宕滆閻撴捇姊洪崷顓炲妺妞ゃ劌鎳愮划濠氼敍濞戞氨鐦堥梻鍌氱墛缁嬫挻鏅跺☉娆嶄簻妞ゆ劧绲剧粈鍐ㄇ庨崶褝韬柟顔界懇椤㈡鍩€椤掑倻鐭嗗☉鏃傛６r ticks闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏃堟暜閸嬫挾绮☉妯诲櫧闁活厽鐟╅弻鐔封枎闄囬褍煤椤擃潿鈧礁鈽夐姀鈥斥偓鐑芥煠绾板崬澧婚柛鐐垫暬濮婄粯鎷呴崨濠冨創濡炪倧瀵岄崹鎶芥嚍闁秵鐒肩€广儱鎳庨崵鎴︽煙閸忚偐鏆橀柛鏂跨Ч閹繝宕橀鐣屽帾婵犮垼娉涢悧鍡涘礉濮樿埖鐓涢柛鈩冪◥閹查箖鏌″畝瀣М妤犵偞顭囬埀顒勬涧閹芥粓鎮块崟顐嬫棃鎮╅棃娑楁勃闂佺粯顨嗛〃鍛粹€﹂崶顏嗙杸闁哄倽顕ф禍婵嬫⒑閸涘﹤濮€闁哄應鏅犻崺鈧い鎺嗗亾缂佸鎳撻～蹇涙惞閸︻厾锛滃┑鈽嗗灣閸樠囁夋径宀€纾藉ù锝堟閽勫吋绻涙径瀣鐎规洘宀搁獮鎺懳旀担闀愮紦缂傚倷绀侀鍫濃枖閺囥埄鏁婇柟鐑橆殕閳锋垿鏌涘☉姗堟缂佸爼浜堕弻娑㈠Ω閿曗偓閳绘洟鎸婂┑瀣叆闁哄洨鍋熼埞姒r ticks闂?
        bottom='off',      # 闂傚倸鍊搁崐鎼佸磹妞嬪海鐭嗗〒姘ｅ亾妤犵偛顦甸弫鎾绘偐閸愯弓鐢婚梻浣瑰濞叉牠宕愯ぐ鎺戠；閻庯綆鍋傜换鍡涙煏閸繃鍣归柡鍡欏枛閺岋綁顢橀悢绋跨３濠殿喖锕ュ钘夌暦瑜版帩鏁嬮柛娑卞幖婢瑰姊绘担渚劸婵炲鍏樺畷浼村冀椤撶偠鎽曢梺璺ㄥ枔婵挳鎮欐繝鍥ㄧ厪濠㈣泛鐗嗛崝銈吤归悩灞傚仮婵﹥妞藉畷銊︾節閸愵亜骞楅梻浣侯焾闁帮絽顭囪椤㈡岸鏁愭径濠囧敹闂佸搫娲ㄩ崑銈夊船鐠鸿　鏀介柣妯肩帛濞懷勭箾濞村娅囨繛鎴犳暬閸┾偓妞ゆ帒鍊荤壕浠嬫煕鐏炲墽鎳呯紒鎰⒒閻ヮ亪顢橀悢绋库偓鎰偓瑙勬穿缂嶄礁鐣峰鈧、娆撳礂閼测斁鍋撻鍕€垫鐐茬仢閸旀碍銇勯敂璇茬仸闁哄被鍔戞俊鑸靛緞鐎ｎ剙骞堥梻浣虹帛閸旀浜稿▎鎾村仒婵犳洜顭秏 edge闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏃堟暜閸嬫挾绮☉妯诲櫧闁活厽鐟╅弻鐔封枎闄囬褍煤閿旈敮鍋撴担鍐ㄤ汗闁逞屽墯缁嬫帡鏁嬫繛瀛樼矤閸ㄨ泛顫忓ú顏勭閹艰揪绲块悾闈涒攽閻愯尙婀撮柛鏂跨Ч婵?
        top='off',         # 闂傚倸鍊搁崐鎼佸磹妞嬪海鐭嗗〒姘ｅ亾妤犵偛顦甸弫鎾绘偐閸愯弓鐢婚梻浣瑰濞叉牠宕愯ぐ鎺戠；閻庯綆鍋傜换鍡涙煏閸繃鍣归柡鍡欏枛閺岋綁顢橀悢绋跨３濠殿喖锕ュ钘夌暦瑜版帩鏁嬮柛娑卞幖婢瑰嫬鈹戦悙鑼憼缂侇喖绉堕崚鎺楀箻鐠囪尪鎽曞┑鐐村灟閸╁嫰寮崘顔界叆婵犻潧妫欓ˉ鐘炽亜閿斿搫鍔︽慨濠冩そ瀹曘劍绻濋崘顏勫箺闂備胶顭堥柊锝咁焽瑜旈、姘舵晲婢跺﹪鍞堕梺鍝勬川閸嬨倝宕捄琛℃斀闁绘绮☉褎绻涘ù瀣珖婵炴垹鏁婚崺鈧い鎺戝€荤壕浠嬫煕鐏炲墽鎳呯紒鎰⒒閻ヮ亪顢橀悢绋库偓鎰偓瑙勬穿缂嶄礁鐣峰鈧、娆撳礂閼测斁鍋撻鍕€垫鐐茬仢閸旀碍銇勯敂璇茬仸闁哄被鍔戞俊鑸靛緞鐎ｎ剙骞楁俊鐐€曠换鎰板箠韫囨稑妫橀柍?edge闂傚倸鍊搁崐鎼佸磹閻戣姤鍊块柨鏃堟暜閸嬫挾绮☉妯诲櫧闁活厽鐟╅弻鐔封枎闄囬褍煤閿旈敮鍋撴担鍐ㄤ汗闁逞屽墯缁嬫帡鏁嬫繛瀛樼矤閸ㄨ泛顫忓ú顏勭閹艰揪绲块悾闈涒攽閻愯尙婀撮柛鏂跨Ч婵?
    labelbottom='off')
    plt.savefig('E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/clusters.png', dpi=200)
    plt.show()
def pSemanMo_3(data):
# Get some pastel shades for the colors
    colorindex=np.array([0,1,2,4,5,6,8,9,10,12,13,14,16])
    colors=plt.cm.Vega20c(colorindex)
    fig=plt.figure(figsize=(9,6))
    ax1 = fig.add_axes([0.2, 0.77, 0.75, 0.06])
    ax2 = fig.add_axes([0.2, 0.15, 0.75, 0.6])
    #add legend
    ax1.set_axis_off()
    cmap=mpl.colors.ListedColormap(colors)
    gradient = np.linspace(0, 1, 256)
    gradient = np.vstack((gradient, gradient))
    ax1.imshow(gradient, aspect='auto', cmap=cmap)
    pos = list(ax1.get_position().bounds)
    x_text = pos[0] - 0.01
    y_text = pos[1] + pos[3]
    fig.text(x_text,y_text,'Semantic travel motifs', va='center', ha='right', fontsize=9)
    blockwidth=pos[2]/13
    for i in range(13):
        x_text_number=pos[0]+(i+1/2)*blockwidth
        y_text_number=pos[1] + pos[3]/2.
        fig.text(x_text_number,y_text_number,'ID=%d'%(i+1), va='center', ha='center', fontsize=9)

    n_rows,columns = np.shape(data)
    index = np.arange(n_rows) + 0.3
    bar_width = 0.4
    # Initialize the vertical-offset for the stacked bar chart.
    y_offset = np.array([0.0] * n_rows)
    # Plot bars
    for i in range(columns):
        ax2.barh(bottom=index, width=data[:,i], height=bar_width, left=y_offset, color=colors[i])
        y_offset = y_offset + data[:,i]

    ax2.set_yticks(index)
    ax2.set_yticklabels(['Chain','Downlinked\nmutual dyad','Cycle','Uplinked\nmutual dyad'],fontsize=9)
    ax2.set_xlim((0.0,1.0))
    ax2.set_xlabel('Percentage',fontsize=9)
    ax2.set_xticks(np.linspace(0.0,1.0,6))
    ax2.set_xticklabels(["%.1f" %i for i in np.linspace(0.0,1.0,6)],fontsize=9)
    #plt.suptitle('Temporal Motifs')
    plt.show()
def plotMatrix(matrix,ind):
    fig,ax=plt.subplots(figsize=(8,6))
    im=ax.imshow(matrix,cmap='viridis')
    #im=ax.matshow(matrix,cmap='viridis')
    cbar=fig.colorbar(im)
    cbar.ax.set_ylabel('Similarity score')
    tickind=np.arange(0,len(ind),30)
    userind=userIndex()
#xticks
    #xind=np.arange(0,len(ind),100)
    ax.set_xticks(tickind)
    ax.set_xlabel('Tourist ID')
    xlabels=tickind
    xlabels=ind[tickind]
    ax.set_xticklabels(xlabels,fontsize=7,rotation='vertical')
#yticks
    ax.set_yticks(tickind)
    #ylabels=tickind
    ylabels=ind[tickind]
    #ylabels=userind[ind[tickind]]
    ax.set_yticklabels(ylabels,fontsize=7)
    ax.set_ylabel('Tourist ID')
    #plt.savefig("E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/Simi")
    plt.show()
def pSampleMatrix(matrix,ind):
    fig = plt.figure(figsize=(5,8))
    ax=fig.add_axes([0,0.1,1.0,0.8])
    im=ax.imshow(matrix,cmap='viridis')
    cbar=fig.colorbar(im,ticks=[0,1,2])#,orientation='horizontal'
    cbar.ax.set_xticklabels(['0', '1', '2'])
    cbar.ax.set_ylabel('The Element\'s Value of User Vector',rotation=-90,va='bottom')
#xticks
    tickind_x=[0,3,16,29]
    ax.set_xticks(tickind_x)
    ax.set_xticklabels([])
#yticks
    tickind_y=[0,49,99,149]
    ax.set_yticks(tickind_y)
    ax.set_yticklabels([])
    #ax.set_ylabel('User ID')
    l = plt.axhline(y=49,color='grey',alpha=0.9)
    l = plt.axhline(y=99,color='grey',alpha=0.9)
#text
    props_c={'ha': 'right', 'va': 'center'}
    text_pos_c=np.array([[-3,24.5],[-3,74],[-3,124]])
    text_c=['Cluster 1','Cluster 2','Cluster 3']
    props_m={'ha': 'center', 'va': 'top'}
    text_pos_m=np.array([[1.5,151],[9.5,151],[22.5,151]])
    text_m=['ToTM','TeTM','STM']
    for i in range(3):
        plt.text(text_pos_c[i,0],text_pos_c[i,1],text_c[i],props_c)
        plt.text(text_pos_m[i,0],text_pos_m[i,1],text_m[i],props_m,rotation=-90,family='serif', style='italic')
    plt.savefig('E:/Senior/Graduation project/Thesis/Figure/userAnalysis/cluster.png', dpi=300)
    plt.show()
def pMeanMatrix(matrix):
    fig = plt.figure(figsize=(5,8))
    ax=fig.add_axes([0,0.1,1.0,0.8])
    im=ax.imshow(matrix,cmap='viridis')
    cbar=fig.colorbar(im)#,orientation='horizontal',ticks=[0,1,2]
##    cbar.ax.set_xticklabels(['0', '1', '2'])
##    cbar.ax.set_ylabel('The Element\'s Value of User Vector',rotation=-90,va='bottom')
###xticks
##    tickind_x=[0,3,16,29]
##    ax.set_xticks(tickind_x)
##    ax.set_xticklabels([])
###yticks
##    tickind_y=[0,49,99,149]
##    ax.set_yticks(tickind_y)
##    ax.set_yticklabels([])
##    #ax.set_ylabel('User ID')
##    l = plt.axhline(y=49,color='grey',alpha=0.9)
##    l = plt.axhline(y=99,color='grey',alpha=0.9)
###text
##    props_c={'ha': 'right', 'va': 'center'}
##    text_pos_c=np.array([[-3,24.5],[-3,74],[-3,124]])
##    text_c=['Cluster 1','Cluster 2','Cluster 3']
##    props_m={'ha': 'center', 'va': 'top'}
##    text_pos_m=np.array([[1.5,151],[9.5,151],[22.5,151]])
##    text_m=['ToTM','TeTM','STM']
##    for i in range(3):
##        plt.text(text_pos_c[i,0],text_pos_c[i,1],text_c[i],props_c)
##        plt.text(text_pos_m[i,0],text_pos_m[i,1],text_m[i],props_m,rotation=-90,family='serif', style='italic')
##    plt.savefig('E:/Senior/Graduation project/Thesis/Figure/userAnalysis/cluster.png', dpi=300)
    plt.show()
def pHist(data):
    fig,ax=plt.subplots()
    ax.hist(data)
    plt.show()
def pEigenSpace_3d(arrayTuple,evectorID):
    #display 3d space
    #the length of arrayTuple stands for the category number
    #each array should be n*3,i.e.,n rows and 3 columns
    #evetorID stands for the index of eigen vectors.3 elments.
    if len(arrayTuple[0][0,:])!=3:
        print('Error:each row should has exact 3 elements')
        return
    print(arrayTuple[0].shape)
    lenarr=len(arrayTuple)
    fig = plt.figure(figsize=(10,5))
    ax = fig.add_subplot(111, projection='3d')
    colorindex=np.arange(0,lenarr,1)
    colorlist=plt.cm.Set2(colorindex)
    markers=['o','^','*','+','s']
    scatter=[0 for i in range(lenarr)]
    for i in range(lenarr):
        scatter[i]=ax.scatter(arrayTuple[i][:,0],arrayTuple[i][:,1],arrayTuple[i][:,2],\
        c=colorlist[i],marker=markers[i])

    ax.set_xlabel('Eigen Vector #'+str(evectorID[0]))
    ax.set_ylabel('Eigen Vector #'+str(evectorID[1]))
    ax.set_zlabel('Eigen Vector #'+str(evectorID[2]))
    #ax.text2D(0.15,1,'User Vector in Eigen Space',fontsize=12,transform=ax.transAxes)
    plt.title('User Vector in Eigen Space',fontsize=12)
    plt.legend((scatter[0],scatter[1],scatter[2]),('Cluster 1','Cluster 2','Cluster 3'),loc='upper right',bbox_to_anchor=(0.1,0.6))
    plt.show()
def pEigenSpace_1(arrayTuple,evectorID):
    lenarr=len(arrayTuple)
    fig = plt.figure(figsize=(10,2))
    ax=fig.add_axes([0.1,0.3,0.7,0.5])
    colorindex=np.arange(0,lenarr,1)
    colorlist=plt.cm.Set2(colorindex)
    markers=['o','^','*','+','s']
    scatter=[0 for i in range(lenarr)]
    eveindex=0
    for i in range(lenarr):
        scatter[i]=ax.scatter(arrayTuple[i][:,eveindex],np.zeros_like(arrayTuple[i][:,eveindex]),\
        c=colorlist[i],marker=markers[i])
    #here!!!!!!!!
    #ax.set_xlabel('Projection onto Eigen Vector #'+str(evectorIDlist[0]+1))
    ax.set_ylim((-0.002,0.002))
    ax.set_yticks([])

    #ax.text(0.15,1,'Users\' Feature Vectors in Eigen Space'+' --'+str(cateNumber)+'Categories of Landmarks',fontsize=12,transform=ax.transAxes)
    plt.title('Projection onto Eigen Vector #'+str(evectorID[eveindex]))
    plt.legend((scatter[0],scatter[1],scatter[2]),('Cluster 1','Cluster 2','Cluster 3'),loc='upper left',bbox_to_anchor=(1,1.02))
    plt.show()
def main():
##    matrix=sMotif4567()
##    pSemanMo_3(matrix)

##    matrix,name=userMatrixNew()
##    print(np.shape(matrix))
##    nsimi,ind,linkage=denMatrix(matrix)
##    functions.saveArray(nsimi,[],'E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/simi_matrix')
##    functions.saveArray(ind,[],'E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/simi_index')
##    functions.saveArray(name,[],'E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/name')
##    functions.saveArray(matrix,[],'E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/matrix')
    #label=[str(i)for i in ind]
    #pDendro(linkage,label)
    matrix=functions.readArray('E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/matrix')
    name=functions.readArray('E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/name')
    ind=functions.readArray('E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/simi_index')
    nsimi=functions.readArray('E:/Senior/Graduation project/YahooFlickr/NewYorktemp/Motifs/Motif_UserName/eigen/figure/simi_matrix')
    plotMatrix(nsimi,ind)
##    sample=[909,107,790,95,213,429]
##    userAnalysis(matrix,name,nsimi,sample)
##pSampleMatrix(nmat,sampleIndex)
    #sampleIndex=np.hstack((np.arange(0,50),np.arange(250,300),np.arange(700,750)))
##    mean1=np.mean(matrix[0:50,:],axis=0)
##    mean2=np.mean(matrix[250:300,:],axis=0)
##    mean3=np.mean(matrix[700:750,:],axis=0)
##    mmat=np.vstack((mean1,mean2,mean3))
##    pMeanMatrix(mmat)

    #eigenSpace(matrix)
if __name__ == '__main__':
    main()
